<div id="intro">
	<h1>
		Revelation
	</h1>
	<p>
		<a href="explanation.html">Explanation</a>
	</p>
	<p>
		<small>
			<Link parameters="{{toggledTranslationParameters}}">
			{{#if currentTranslation === translations.greek}}
				English
			{{else}}
				Greek
			{{/if}}
			</Link>
		</small>
	</p>
</div>

<div data-chiasm-selected="{{!!currentChiasm}}">
	{{#each visibleSections as outerChiasm}}
		<div
			class="chiasm-section"
			data-is-selected="{{!!currentChiasm && currentChiasm === outerChiasm.identifier}}"
		>
			{{#if subsectionIsSelected}}
				<div class="color-bar">
					{{sectionLabel(outerChiasm)}}
				</div>
			{{else}}
			<Link
				className="color-bar chiasm-color-bar"
				style="background-color: {{chiasmColorBarColor(outerChiasm.identifier)}}"
				parameters="{{ getLinkParameters(outerChiasm.identifier) }}"
			>
				{{sectionLabel(outerChiasm)}}
			</Link>
			{{/if}}
			<div class="section-body">
				{{#if !currentSubsection}}
				<SectionLine
					description="{{outerChiasm.description}}"
					descriptionClass="header-margin"
					anchor="{{outerChiasm.anchor}}"
					siblingAnchor="{{outerChiasm.siblingAnchor}}"
					siblingIsDown="{{outerChiasm.siblingIsDown}}"
				>
					<h1 style="color: {{chiasmColorBarColor(outerChiasm.identifier)}}">
						{{outerChiasm.title}}
					</h1>
				</SectionLine>
				{{/if}}

				{{#if outerChiasm.introduction}}
					{{#if outerChiasm.introduction.subsections}}
						<Subsections
							subsections="{{outerChiasm.introduction.subsections}}"
							chiasmIdentifier="{{outerChiasm.identifier}}"
							currentSubsection="{{currentSubsection}}"
							verses="{{extractRangeFromVerses(outerChiasm.verses, outerChiasm.introduction.range)}}"
							showColorBar="{{!!currentChiasm}}"
						/>
					{{elseif !currentSubsection || currentSubsection === 'introduction'}}
						<SectionLine
							description="{{outerChiasm.introduction.title}}"
							chiasmIdentifier="{{outerChiasm.identifier}}"
							sectionIdentifier="introduction"
							zoomedIn="{{subsectionIsSelected}}"
							showColorBar="{{!!currentChiasm}}"
							anchor="{{outerChiasm.introduction.anchor}}"
							siblingAnchor="{{outerChiasm.introduction.siblingAnchor}}"
							siblingIsDown="{{outerChiasm.introduction.siblingIsDown}}"
							range="{{outerChiasm.introduction.range}}"
						>
							<Paragraphs verses="{{extractRangeFromVerses(outerChiasm.verses, outerChiasm.introduction.range)}}" />
						</SectionLine>
					{{/if}}
				{{/if}}

				{{#if outerChiasm.subsections}}
					<Subsections
						subsections="{{outerChiasm.subsections}}"
						chiasmIdentifier="{{outerChiasm.identifier}}"
						currentSubsection="{{currentSubsection}}"
						verses="{{extractRangeFromVerses(outerChiasm.verses, outerChiasm.range)}}"
						showColorBar="{{!!currentChiasm}}"
					/>
				{{elseif !currentSubsection}}
					<SectionLine range="{{outerChiasm.range}}">
						<Paragraphs verses="{{extractRangeFromVerses(outerChiasm.verses, outerChiasm.range)}}" />
					</SectionLine>
				{{/if}}
			</div>
		</div>
	{{/each}}
</div>

<style>
[data-chiasm-selected=true] [data-is-selected=true] {
	margin-bottom: 20px;
}

[data-chiasm-selected=true] .chiasm-color-bar {
	color: #7d7d7d;
}
</style>

<script>
const Paragraphs = require('component/paragraphs.html')
const Subsections = require('component/subsections.html')
const SectionLine = require('component/section-line.html')

const { Link } = require('lib/router-instance')

const structure = require('lib/structure')
const sectionLabel = require('lib/section-label')
const extractRangeFromVerses = require('lib/extract-range-from-verses')
const getChiasmColor = require('lib/identifier-color')
const combineStructureAndVerses = require('lib/combine-structure-and-verses')
const getParametersWithTranslationToggled = require('lib/toggle-translation-parameter')

export default {
	computed: {
		toggledTranslationParameters: (querystringParameters) => {
			return querystringParameters
				? getParametersWithTranslationToggled(querystringParameters)
				: {}
		},
		currentChiasm: querystringParameters => {
			return querystringParameters && querystringParameters.chiasm
		},
		currentSubsection: querystringParameters => {
			return querystringParameters && querystringParameters.section
		},
		subsectionIsSelected: currentSubsection => !!currentSubsection,
		getLinkParameters: currentChiasm => {
			return chiasmIdentifier => {
				return currentChiasm === chiasmIdentifier
					? {}
					: { chiasm: chiasmIdentifier }
			}
		},
		chiasmColorBarColor(currentChiasm) {
			if (currentChiasm) {
				return () => '#d8d8d8'
			} else {
				return getChiasmColor
			}
		},
		currentTranslation: (querystringParameters, translations) => {
			return querystringParameters && querystringParameters.translation === 'greek'
				? translations.greek
				: translations.english
		},
		structuredText: currentTranslation => {
			return combineStructureAndVerses(structure, currentTranslation)
		},
		visibleSections: (structuredText, currentChiasm) => {
			if (!currentChiasm) {
				return structuredText
			}

			return structuredText.filter(outerChiasm => currentChiasm === outerChiasm.identifier)
		}
	},
	components: {
		Paragraphs,
		Subsections,
		SectionLine,
		Link
	},
	helpers: {
		extractRangeFromVerses,
		sectionLabel
	}
}
</script>
